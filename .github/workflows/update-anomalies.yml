name: Update Recent Anomalies

on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'

  # Allow manual triggering
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-readme:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Fetch latest anomalies from GCS
        run: |
          echo "Fetching latest anomalies from Cloud Function..."
          curl -s https://us-central1-nonrecognition.cloudfunctions.net/getAnomaliesWithContributors \
            -o anomalies.json

          # Extract URLs for the 9 most recent anomalies
          cat anomalies.json | python3 -c "
          import json, sys
          data = json.load(sys.stdin)
          # Sort by time_created (most recent first)
          data.sort(key=lambda x: x['time_created'], reverse=True)
          # Get first 9 URLs
          for item in data[:9]:
              print(item['gcs_public_url'])
          " > anomalies.txt

          echo "Found $(cat anomalies.txt | wc -l) anomaly images"

      - name: Update README with latest images
        run: python3 .github/scripts/update_readme_images.py

      - name: Check for changes
        id: check_changes
        run: |
          if git diff --quiet README.md; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No changes to README.md"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "README.md has been updated"
          fi

      - name: Commit and push changes
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git commit -m "ðŸ¤– Auto-update: Latest anomaly discoveries from distributed network

          Updated README.md with 9 most recent anomaly images from GCS.
          Generated by GitHub Actions on $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          git push

      - name: Cleanup
        if: always()
        run: |
          rm -f anomalies.json anomalies.txt
